<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Wind Tunnel Lab ‚Äî Variable Cross-Section</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #f2f4f7;
  --surface:   #ffffff;
  --surface2:  #f5f7fa;
  --border:    #d0d8e4;
  --border-lt: #e2e8f0;
  --text:      #1a202c;
  --text-md:   #4a5568;
  --text-lt:   #718096;
  --accent:    #1a56a0;
  --accent-h:  #0f3675;
  --accent-bg: #ebf3fc;
  --c-cont:    #b45309;
  --c-throat:  #1a7a4a;
  --c-diff:    #1a56a0;
  --ok:        #1a7a4a;
  --ok-bg:     #e6f6ee;
  --err:       #b71c1c;
  --err-bg:    #fdecea;
  --ff:        'Inter', system-ui, sans-serif;
  --serif:     'Source Serif 4', Georgia, serif;
  --mono:      'JetBrains Mono', 'Courier New', monospace;
  --r:         8px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 18px; }
body {
  font-family: var(--serif);
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  min-height: 100vh;
  -webkit-text-size-adjust: 100%;
}
.wizard { display: flex; flex-direction: column; height: 100dvh; }

/* TOP BAR */
.topbar {
  flex-shrink: 0;
  background: #1a2e44;
  border-bottom: 4px solid var(--accent);
  padding: 18px 20px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}
.topbar-title {
  font-family: var(--ff);
  font-size: clamp(1.1rem, 4vw, 1.45rem);
  font-weight: 700;
  color: #ffffff;
  line-height: 1.2;
}
.topbar-sub {
  font-family: var(--serif);
  font-size: clamp(0.78rem, 3vw, 0.92rem);
  color: #90afc8;
  font-style: italic;
  margin-top: 2px;
}
.steps-row { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.step-pip {
  cursor: pointer;
  width: 32px; height: 32px;
  border-radius: 50%;
  border: 2px solid #344e6b;
  background: #243a55;
  color: #6a8ba8;
  font-family: var(--ff);
  font-size: 0.8rem;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.25s;
  flex-shrink: 0;
}
.step-pip.active { border-color: var(--accent); background: var(--accent); color: #fff; }
.step-pip.done   { border-color: var(--accent-h); background: var(--accent-bg); color: var(--accent); }
.step-connector  { width: 18px; height: 2px; background: #344e6b; flex-shrink: 0; }

/* SLIDES */
.slides-viewport { flex: 1; position: relative; overflow: hidden; }
.slide {
  position: absolute; inset: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 22px 20px 40px;
  opacity: 0;
  pointer-events: none;
  transform: translateX(48px);
  transition: opacity 0.3s ease, transform 0.3s ease;
  will-change: opacity, transform;
}
.slide.active { opacity: 1; pointer-events: all; transform: translateX(0); }
.slide.exit   { opacity: 0; transform: translateX(-48px); }
.slide-body   { max-width: 860px; margin: 0 auto; }

.slide-h {
  font-family: var(--ff);
  font-size: 1.25rem;
  font-weight: 700;
  color: #1a2e44;
  margin-bottom: 6px;
  line-height: 1.3;
}
.slide-lead {
  font-family: var(--serif);
  font-size: 1rem;
  color: var(--text-md);
  font-style: italic;
  margin-bottom: 22px;
  line-height: 1.7;
}

/* DIAGRAM CARD */
.diagram-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px 18px 12px;
  margin-bottom: 18px;
}
.diagram-card svg { width: 100%; height: auto; display: block; }
.diagram-note {
  font-size: 0.8rem;
  color: var(--text-lt);
  font-style: italic;
  margin-top: 8px;
  line-height: 1.5;
}

/* INFO BOX */
.info-box {
  background: var(--accent-bg);
  border-left: 5px solid var(--accent);
  border-radius: 0 var(--r) var(--r) 0;
  padding: 16px 20px;
  margin-bottom: 20px;
  font-family: var(--serif);
  font-size: 0.95rem;
  color: #0f2a4a;
  line-height: 1.75;
}
.info-box .eq {
  font-family: var(--mono);
  font-size: 0.92rem;
  font-weight: 500;
  margin: 8px 0;
  display: block;
  line-height: 1.6;
}
.info-box .eq .cs { color: var(--c-cont);   font-weight: 700; }
.info-box .eq .ct { color: var(--c-throat); font-weight: 700; }
.info-box .eq .cd { color: var(--c-diff);   font-weight: 700; }

/* SECTION BADGE */
.sec-badge {
  display: inline-block;
  font-family: var(--ff);
  font-size: 0.65rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  padding: 3px 10px;
  border-radius: 20px;
  font-weight: 700;
  margin-bottom: 4px;
}
.sec-contraction { background: #fef3e0; color: #92400e; }
.sec-throat      { background: #e6f6ee; color: #134e35; }
.sec-diffuser    { background: var(--accent-bg); color: #0f3675; }

/* MEASUREMENT SECTION */
.meas-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  margin-bottom: 16px;
  overflow: hidden;
}
.meas-header {
  padding: 13px 18px 10px;
  border-bottom: 1px solid var(--border-lt);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.meas-header h3 {
  font-family: var(--ff);
  font-size: 0.95rem;
  font-weight: 700;
  color: #1a2e44;
}
.meas-body { padding: 16px 18px; }

/* TAPPING GRID */
.tap-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
@media (max-width: 520px) { .tap-grid { grid-template-columns: 1fr 1fr; } }

.tap-fld { display: flex; flex-direction: column; gap: 4px; }
.tap-fld label {
  font-family: var(--ff);
  font-size: 0.7rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  font-weight: 700;
  color: var(--text-md);
}
.tap-fld.f-cont label { color: var(--c-cont); }
.tap-fld.f-throat label { color: var(--c-throat); }
.tap-fld.f-diff label { color: var(--c-diff); }
.tap-sub {
  font-family: var(--mono);
  font-size: 0.68rem;
  color: var(--text-lt);
  line-height: 1.2;
}
.tap-fld input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--surface2);
  color: var(--text);
  font-family: var(--mono);
  font-size: 1rem;
  min-height: 44px;
  transition: border-color 0.15s, box-shadow 0.15s;
  -webkit-appearance: none;
  appearance: none;
}
.tap-fld input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(26,86,160,0.15);
  background: #fff;
}

/* PITOT SECTION */
.pitot-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 5px solid #7c3aed;
  border-radius: var(--r);
  padding: 16px 18px;
  margin-bottom: 10px;
  transition: border-left-color 0.2s;
}
.pitot-card.complete { border-left-color: var(--ok); }
.pitot-card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.pitot-label {
  font-family: var(--ff);
  font-size: 0.78rem;
  font-weight: 700;
  color: #7c3aed;
  letter-spacing: 0.07em;
  text-transform: uppercase;
}
.pitot-label.complete { color: var(--ok); }
.pitot-fields { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
@media (max-width: 500px) { .pitot-fields { grid-template-columns: 1fr 1fr; } }

.btn-rm {
  background: transparent;
  color: #b71c1c;
  border: 1px solid #b71c1c;
  padding: 7px 14px;
  border-radius: 5px;
  cursor: pointer;
  font-family: var(--ff);
  font-size: 0.82rem;
  font-weight: 600;
  min-height: 40px;
  transition: background 0.15s;
}
.btn-rm:hover { background: var(--err-bg); }

.btn-add {
  font-family: var(--ff);
  font-size: 1rem;
  font-weight: 600;
  padding: 12px 24px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-md);
  cursor: pointer;
  min-height: 48px;
  transition: border-color 0.15s, color 0.15s;
}
.btn-add:hover { border-color: var(--accent); color: var(--accent); }

.btn-proceed {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-family: var(--ff);
  font-size: 1rem;
  font-weight: 600;
  padding: 14px 28px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--r);
  cursor: pointer;
  min-height: 50px;
  margin-top: 20px;
  transition: background 0.15s, opacity 0.15s;
}
.btn-proceed:hover:not(:disabled) { background: var(--accent-h); }
.btn-proceed:disabled { opacity: 0.35; cursor: not-allowed; }
.btn-proceed .arr { font-size: 1.1rem; }

.btn-back {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-family: var(--ff);
  font-size: 1rem;
  font-weight: 600;
  padding: 14px 24px;
  background: var(--surface);
  color: var(--text-md);
  border: 1px solid var(--border);
  border-radius: var(--r);
  cursor: pointer;
  min-height: 50px;
  transition: border-color 0.15s, color 0.15s;
}
.btn-back:hover { border-color: var(--accent); color: var(--accent); }
.btn-back .arr { font-size: 1.1rem; }

/* RESULTS CHARTS */
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
@media (max-width: 640px) { .charts-grid { grid-template-columns: 1fr; } }
.chart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px 16px;
}
.chart-card h3 { font-family: var(--ff); font-size: 1rem; font-weight: 700; color: #1a2e44; margin-bottom: 6px; }
.ch-note { font-family: var(--serif); font-size: 0.9rem; color: var(--text-md); line-height: 1.65; margin-bottom: 14px; }
.clr-legend { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 10px; }
.clr-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: var(--text-md); }
.clr-swatch { width: 22px; height: 4px; border-radius: 2px; flex-shrink: 0; }
.chart-sel-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.chart-sel-row label { font-family: var(--ff); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-md); }
.chart-sel-row select {
  font-family: var(--ff);
  font-size: 0.9rem;
  padding: 7px 10px;
  border: 1px solid var(--border);
  border-radius: 5px;
  background: var(--surface2);
  color: var(--text);
  min-height: 40px;
  -webkit-appearance: none;
  appearance: none;
}

/* RESULTS TABLE */
.res-table-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  overflow-x: auto;
  margin-bottom: 20px;
}
table.res-table { width: 100%; border-collapse: collapse; font-family: var(--mono); font-size: 0.8rem; }
table.res-table thead th {
  font-family: var(--ff);
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-lt);
  padding: 12px 14px 8px;
  text-align: right;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
table.res-table thead th:first-child { text-align: left; }
table.res-table tbody td { padding: 9px 14px; text-align: right; border-bottom: 1px solid var(--border-lt); }
table.res-table tbody td:first-child { text-align: left; font-weight: 700; }
table.res-table tbody tr:last-child td { border-bottom: none; }
table.res-table tbody tr:hover td { background: #f8fafc; }
.zone-tag {
  display: inline-block;
  font-family: var(--ff);
  font-size: 0.6rem;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  padding: 2px 7px;
  border-radius: 10px;
  margin-left: 4px;
  vertical-align: middle;
}
.zt-c { background: #fef3e0; color: #92400e; }
.zt-t { background: #e6f6ee; color: #134e35; }
.zt-d { background: var(--accent-bg); color: #0f3675; }

/* QUIZ */
.quiz-meta { display: flex; align-items: center; justify-content: space-between; gap: 14px; margin-bottom: 22px; flex-wrap: wrap; }
.q-prog-label { font-family: var(--ff); font-size: 0.78rem; color: var(--text-lt); }
.q-prog-track { flex: 1; min-width: 100px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.q-prog-fill  { height: 100%; background: var(--ok); border-radius: 3px; transition: width 0.35s ease; }

.u-unit { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; margin-bottom: 16px; }
.u-unit-body { padding: 18px 20px; }
.u-stem { font-family: var(--ff); font-size: 1rem; font-weight: 700; color: #1a2e44; margin-bottom: 6px; line-height: 1.45; }
.u-desc { font-family: var(--serif); font-size: 0.95rem; color: var(--text-md); line-height: 1.7; margin-bottom: 14px; }

.q-badge {
  display: inline-block;
  font-family: var(--ff);
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 3px 9px;
  border-radius: 20px;
  margin-bottom: 10px;
  font-weight: 700;
}
.q-obs { background: #e3f2fd; color: #0d47a1; }
.q-exp { background: var(--ok-bg); color: #134e35; }
.q-prd { background: #fff8e1; color: #e65100; }

.mc-opt {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 13px 15px;
  margin: 8px 0;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  font-family: var(--serif);
  font-size: 1rem;
  line-height: 1.55;
  transition: border-color 0.15s, background 0.15s;
  -webkit-tap-highlight-color: transparent;
  min-height: 48px;
}
.mc-opt:hover { border-color: var(--accent); background: var(--accent-bg); }
.mc-opt input { margin-top: 4px; flex-shrink: 0; accent-color: var(--accent); width: 18px; height: 18px; }
.mc-opt.locked { opacity: 0.6; cursor: default; pointer-events: none; }

.q-feedback { display: none; margin-top: 14px; padding: 14px 16px; border-radius: 6px; font-family: var(--serif); font-size: 0.95rem; line-height: 1.7; }
.q-feedback.show { display: block; }
.fb-ok  { background: var(--ok-bg);  border-left: 5px solid var(--ok);  color: #133e28; }
.fb-err { background: var(--err-bg); border-left: 5px solid var(--err); color: #5c0a0a; }

.q-context {
  font-family: var(--serif);
  font-size: 0.95rem;
  color: var(--text-md);
  font-style: italic;
  line-height: 1.7;
  margin-bottom: 16px;
  padding-left: 14px;
  border-left: 4px solid var(--border);
}

/* COMPLETION */
.completion-banner {
  display: none;
  margin-top: 28px;
  padding: 28px 24px;
  background: linear-gradient(135deg, var(--ok-bg) 0%, #f0faf5 100%);
  border: 2px solid var(--ok);
  border-radius: var(--r);
  text-align: center;
}
.completion-banner.show { display: block; }
.completion-icon { font-size: 2.8rem; line-height: 1; margin-bottom: 12px; }
.completion-title { font-family: var(--ff); font-size: 1.3rem; font-weight: 700; color: #134e35; margin-bottom: 8px; }
.completion-msg { font-family: var(--serif); font-size: 1rem; color: #1b4020; line-height: 1.75; max-width: 560px; margin: 0 auto; }

/* INLINE MINI-CHART CARDS IN QUESTIONS */
.q-chart-card {
  background: var(--surface2);
  border: 1px solid var(--border-lt);
  border-radius: 6px;
  padding: 14px 16px 10px;
  margin-bottom: 16px;
}
.q-chart-card .q-chart-title {
  font-family: var(--ff);
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-lt);
  margin-bottom: 10px;
}

/* DYN INFO BUTTON */
.btn-dyn-info {
  font-family: var(--ff);
  font-size: 0.82rem;
  font-weight: 600;
  padding: 9px 16px;
  background: var(--surface2);
  border: 1px solid var(--accent);
  border-radius: 6px;
  color: var(--accent);
  cursor: pointer;
  min-height: 40px;
  transition: background 0.15s, color 0.15s;
  white-space: nowrap;
  flex-shrink: 0;
}
.btn-dyn-info:hover, .btn-dyn-info.open {
  background: var(--accent);
  color: #fff;
}
</style>
</head>
<body>
<div class="wizard">

  <header class="topbar">
    <div>
      <div class="topbar-title">Flow Energy Conservation</div>
      <div class="topbar-sub">Static &amp; Dynamic Pressure ¬∑ Continuity ¬∑ Pitot Tube</div>
    </div>
    <div class="steps-row">
      <div class="step-pip active" id="sp1" onclick="goTo(1)">1</div>
      <div class="step-connector"></div>
      <div class="step-pip" id="sp2" onclick="goTo(2)">2</div>
      <div class="step-connector"></div>
      <div class="step-pip" id="sp3" onclick="goTo(3)">3</div>
      <div class="step-connector"></div>
      <div class="step-pip" id="sp4" onclick="goTo(4)">4</div>
    </div>
  </header>

  <div class="slides-viewport">

    <!-- ‚ïê‚ïê SLIDE 1 ‚Äî DATA ENTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="slide active" id="s1">
      <div class="slide-body">
        <div class="slide-h">Record your measurements</div>
        <div class="slide-lead">Enter the gauge static pressure (mmH‚ÇÇO) at each tapping point, then your pitot tube readings at the throat and in the diffuser.</div>

        <!-- TUNNEL DIAGRAM -->
        <div class="diagram-card">
          <svg id="diag-svg" viewBox="0 0 820 170" xmlns="http://www.w3.org/2000/svg">
            <!-- built by JS -->
          </svg>
          <div class="diagram-note">
            Tapping points P1‚ÄìP3: contraction ¬∑ P4‚ÄìP6: constant throat section ¬∑ P7‚ÄìP11: diffuser.
          </div>
        </div>

        <!-- hidden fixed settings used by analysis -->
        <input type="hidden" id="inp-rho" value="1.225">
        <input type="hidden" id="inp-punit" value="mmH2O">
        <input type="hidden" id="inp-ptype" value="gauge">

        <!-- STATIC TAPPINGS: CONTRACTION -->
        <div class="meas-section">
          <div class="meas-header">
            <span class="sec-badge sec-contraction">Contraction</span>
            <h3>Static Pressure ‚Äî P1 to P3 &nbsp;<span style="font-family:var(--mono);font-size:0.75rem;font-weight:400;color:var(--text-lt);">(mmH‚ÇÇO gauge)</span></h3>
          </div>
          <div class="meas-body">
            <div class="tap-grid">
              <div class="tap-fld f-cont"><label>P1</label>
                <input type="number" id="p1" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-cont"><label>P2</label>
                <input type="number" id="p2" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-cont"><label>P3</label>
                <input type="number" id="p3" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
            </div>
          </div>
        </div>

        <!-- STATIC TAPPINGS: THROAT -->
        <div class="meas-section">
          <div class="meas-header">
            <span class="sec-badge sec-throat">Throat (Constant Section)</span>
            <h3>Static Pressure ‚Äî P4 to P6 &nbsp;<span style="font-family:var(--mono);font-size:0.75rem;font-weight:400;color:var(--text-lt);">(mmH‚ÇÇO gauge)</span></h3>
          </div>
          <div class="meas-body">
            <div class="tap-grid">
              <div class="tap-fld f-throat"><label>P4</label>
                <input type="number" id="p4" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-throat"><label>P5</label>
                <input type="number" id="p5" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-throat"><label>P6</label>
                <input type="number" id="p6" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
            </div>
          </div>
        </div>

        <!-- STATIC TAPPINGS: DIFFUSER -->
        <div class="meas-section">
          <div class="meas-header">
            <span class="sec-badge sec-diffuser">Diffuser</span>
            <h3>Static Pressure ‚Äî P7 to P11 &nbsp;<span style="font-family:var(--mono);font-size:0.75rem;font-weight:400;color:var(--text-lt);">(mmH‚ÇÇO gauge)</span></h3>
          </div>
          <div class="meas-body">
            <div class="tap-grid">
              <div class="tap-fld f-diff"><label>P7</label>
                <input type="number" id="p7" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-diff"><label>P8</label>
                <input type="number" id="p8" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-diff"><label>P9</label>
                <input type="number" id="p9" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-diff"><label>P10</label>
                <input type="number" id="p10" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-diff"><label>P11</label>
                <input type="number" id="p11" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
            </div>
          </div>
        </div>

        <!-- THROAT PITOT -->
        <div class="meas-section">
          <div class="meas-header">
            <span class="sec-badge sec-throat">Pitot Tube ‚Äî Throat</span>
            <h3>Pitot Readings at Throat &nbsp;<span style="font-family:var(--mono);font-size:0.75rem;font-weight:400;color:var(--text-lt);">(mmH‚ÇÇO gauge)</span></h3>
          </div>
          <div class="meas-body">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
              <div class="tap-fld f-throat"><label>Total pressure P‚ÇÄ</label>
                <input type="number" id="pitot-p0" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-throat"><label>Static pressure P‚Çõ</label>
                <input type="number" id="pitot-ps" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
              <div class="tap-fld f-throat"><label>Direct velocity (m/s) <span style="font-weight:400;color:var(--text-lt);"></span></label>
                <input type="number" id="pitot-v" step="0.01" placeholder="‚Äî" inputmode="decimal" oninput="checkReady()">
              </div>
            </div>
          </div>
        </div>

        <!-- DIFFUSER PITOT (fixed single reading) -->
        <div class="meas-section">
          <div class="meas-header">
            <span class="sec-badge sec-diffuser">Pitot Tube ‚Äî Diffuser</span>
            <h3>Pitot Readings in Diffuser &nbsp;<span style="font-family:var(--mono);font-size:0.75rem;font-weight:400;color:var(--text-lt);">(mmH‚ÇÇO gauge)</span></h3>
          </div>
          <div class="meas-body">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
              <div class="tap-fld f-diff"><label>Total pressure P‚ÇÄ</label>
                <input type="number" id="diff-p0" step="0.1" placeholder="‚Äî" inputmode="decimal">
              </div>
              <div class="tap-fld f-diff"><label>Static pressure P‚Çõ</label>
                <input type="number" id="diff-ps" step="0.1" placeholder="‚Äî" inputmode="decimal">
              </div>
              <div class="tap-fld f-diff"><label>Direct velocity (m/s) <span style="font-weight:400;color:var(--text-lt);"></span></label>
                <input type="number" id="diff-v" step="0.01" placeholder="‚Äî" inputmode="decimal">
              </div>
            </div>
          </div>
        </div>



        <button class="btn-proceed" id="btn-analyse" onclick="runAnalysis()" disabled>
          Move to analysis <span class="arr">‚Üí</span>
        </button>
      </div>
    </div><!-- /s1 -->

    <!-- ‚ïê‚ïê SLIDE 2 ‚Äî ANALYSIS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="slide" id="s2">
      <div class="slide-body">
        <div class="slide-h">Analysis</div>
        <div class="slide-lead">Static and dynamic pressure at each tapping point, plotted along the duct.</div>

        <!-- COMBINED PRESSURE CHART -->
        <div class="chart-card" style="margin-bottom:16px;">
          <!-- SIGN CONVENTION NOTE -->
          <div style="margin-bottom:14px;padding:11px 14px;background:#fff8e1;border-left:4px solid #f59e0b;border-radius:0 6px 6px 0;font-family:var(--serif);font-size:0.9rem;color:#78350f;line-height:1.65;">
            <strong style="font-family:var(--ff);">Note on sign convention:</strong> The electronic manometer reads magnitude ‚Äî it always shows a positive number.
            In this experiment the static pressures in the contraction and throat are below atmospheric, so we convert them to
            <em>negative values</em> before plotting. You enter the positive reading from the wind tunnel software; the tool applies the sign automatically.
          </div>
          <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:4px;">
            <div>
              <h3 style="margin-bottom:4px;">Pressure distribution ‚Äî P1 to P11</h3>
              <div class="clr-legend" style="margin-bottom:0;">
                <span class="clr-item"><span class="clr-swatch" style="background:#1a56a0;"></span>Static pressure (Pa)</span>
                <span class="clr-item"><span class="clr-swatch" style="background:#bf360c;"></span>Dynamic pressure (Pa)</span>
                <span class="clr-item"><span class="clr-swatch" style="background:#263238;"></span>Total pressure (Pa)</span>
              </div>
            </div>
            <button class="btn-dyn-info" id="btn-dyn-info" onclick="toggleDynInfo()">How is dynamic pressure calculated?</button>
          </div>

          <!-- EXPANDABLE EXPLANATION -->
          <div id="dyn-info-panel" style="display:none;margin:14px 0 6px;padding:16px 18px;background:var(--accent-bg);border-left:5px solid var(--accent);border-radius:0 var(--r) var(--r) 0;">
            <p style="font-family:var(--ff);font-size:0.9rem;font-weight:700;color:#0f2a4a;margin-bottom:8px;">How dynamic pressure is estimated at each tapping point</p>
            <p style="font-family:var(--serif);font-size:0.93rem;color:#0f2a4a;line-height:1.7;margin-bottom:12px;">
              We measure velocity directly at the throat using the pitot tube: the pitot gives total pressure P‚ÇÄ and static pressure P‚Çõ,
              and from these we compute the throat velocity. We then apply the <strong>continuity equation</strong> to estimate velocity
              at every other tapping position ‚Äî since mass must be conserved, a smaller cross-section means higher velocity, and vice versa.
              Dynamic pressure at each point follows as ¬ΩœÅV¬≤.
            </p>
            <div style="background:#fff;border:1px solid var(--border);border-radius:6px;padding:12px 16px;margin-bottom:14px;font-family:var(--mono);font-size:0.95rem;color:#1a2e44;line-height:1.9;">
              <div style="color:#1a7a4a;font-weight:700;">V<sub style="font-size:0.75em;">throat</sub> = ‚àö( 2 √ó (P‚ÇÄ ‚àí P‚Çõ) / œÅ )</div>
              <div style="color:#1a56a0;font-weight:700;margin-top:4px;">V<sub style="font-size:0.75em;">i</sub> = V<sub style="font-size:0.75em;">throat</sub> √ó A<sub style="font-size:0.75em;">throat</sub> / A<sub style="font-size:0.75em;">i</sub></div>
              <div style="color:#b45309;font-weight:700;margin-top:4px;">q<sub style="font-size:0.75em;">i</sub> = ¬Ω œÅ V<sub style="font-size:0.75em;">i</sub>¬≤</div>
            </div>
            <p style="font-family:var(--ff);font-size:0.8rem;font-weight:700;color:#0f2a4a;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em;">Tapping point positions on the duct</p>
            <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden;background:#fff;">
              <img id="tappings-img"
                   src="https://raw.githubusercontent.com/Nidiana/LabsDiscussion/refs/heads/main/FlowEnergyConversion/tappings.PNG"
                   alt="Tapping point locations on the variable cross-section duct"
                   style="width:100%;display:block;"
                   onerror="tryNextImgSrc(this)">
              <div id="tappings-fallback" style="display:none;padding:14px;font-family:var(--serif);font-size:0.88rem;color:var(--text-lt);text-align:center;">
                Image could not be loaded.
              </div>
            </div>
          </div>

          <canvas id="pressureChart" height="260"></canvas>
        </div>

        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:20px;">
          <button class="btn-back" onclick="goTo(1)"><span class="arr">‚Üê</span> Back</button>
          <button class="btn-proceed" style="margin-top:0;" onclick="goTo(3)">Move to understanding <span class="arr">‚Üí</span></button>
        </div>
      </div>
    </div><!-- /s2 -->

    <!-- ‚ïê‚ïê SLIDE 3 ‚Äî UNDERSTANDING (5 questions) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="slide" id="s3">
      <div class="slide-body">
        <div class="slide-h">Understanding</div>
        <div class="slide-lead">Five questions based on your measurements and the principles governing flow through a variable cross-section duct.</div>

        <div class="quiz-meta">
          <span class="q-prog-label" id="uprog-lbl">0 of 5 answered</span>
          <div class="q-prog-track"><div class="q-prog-fill" id="uprog-fill" style="width:0%"></div></div>
        </div>

        <!-- U1 ‚Äî correct: B -->
        <div class="u-unit">
          <div class="u-unit-body">
            <span class="q-badge q-obs">Observe</span>
            <div class="u-stem">Q1 ‚Äî Velocity across the duct</div>
            <div class="u-desc">Look at the velocity profile plotted below, estimated from your pitot measurement using the continuity equation. How does the velocity at the throat (P4‚ÄìP6) compare to the inlet (P1) and the diffuser exit (P11)?</div>
            <div class="q-chart-card">
              <div class="q-chart-title">Estimated velocity ‚Äî P1 to P11</div>
              <canvas id="q1-velChart" height="160"></canvas>
            </div>
            <label class="mc-opt"><input type="radio" name="u1" value="A" onchange="checkU(1,'A')"> A &nbsp; Velocity is highest at the inlet P1 and decreases continuously toward the exit</label>
            <label class="mc-opt"><input type="radio" name="u1" value="B" onchange="checkU(1,'B')"> B &nbsp; Velocity peaks at the throat (P4‚ÄìP6) where the duct is narrowest, then decreases again in the diffuser</label>
            <label class="mc-opt"><input type="radio" name="u1" value="C" onchange="checkU(1,'C')"> C &nbsp; Velocity is constant everywhere because the mass flow rate is constant</label>
            <label class="mc-opt"><input type="radio" name="u1" value="D" onchange="checkU(1,'D')"> D &nbsp; Velocity is lowest at the throat because pressure is lowest there</label>
            <div id="uFb1" class="q-feedback"></div>
          </div>
        </div>

        <!-- U2 ‚Äî correct: C -->
        <div class="u-unit">
          <div class="u-unit-body">
            <span class="q-badge q-exp">Explain</span>
            <div class="u-stem">Q2 ‚Äî How were velocities estimated at every tapping point?</div>
            <div class="u-desc">The velocities shown in the chart above were estimated at all 11 tapping points using the pitot tube reading at the throat together with the known cross-sectional areas at each position. What physical principle makes it possible to propagate a single velocity measurement to every other location in the duct?</div>
            <label class="mc-opt"><input type="radio" name="u2" value="A" onchange="checkU(2,'A')"> A &nbsp; Bernoulli's equation: total pressure is the same at all cross-sections</label>
            <label class="mc-opt"><input type="radio" name="u2" value="B" onchange="checkU(2,'B')"> B &nbsp; Newton's second law: force equals rate of change of momentum</label>
            <label class="mc-opt"><input type="radio" name="u2" value="C" onchange="checkU(2,'C')"> C &nbsp; Conservation of mass: for incompressible steady flow, Q = AV = constant, so knowing V at one cross-section and all areas gives V everywhere</label>
            <label class="mc-opt"><input type="radio" name="u2" value="D" onchange="checkU(2,'D')"> D &nbsp; The ideal gas law: pressure and volume are inversely proportional</label>
            <div id="uFb2" class="q-feedback"></div>
          </div>
        </div>

        <!-- U3 ‚Äî correct: A -->
        <div class="u-unit">
          <div class="u-unit-body">
            <span class="q-badge q-exp">Explain</span>
            <div class="u-stem">Q3 ‚Äî Static Pressure in the Diffuser</div>
            <div class="u-desc">In the diverging diffuser section (P7‚ÄìP11), the cross-sectional area increases. According to the continuity and Bernoulli equations, what should happen to static pressure?</div>
            <label class="mc-opt"><input type="radio" name="u3" value="A" onchange="checkU(3,'A')"> A &nbsp; Static pressure should increase as velocity decreases ‚Äî partial recovery of the pressure "lost" in the contraction</label>
            <label class="mc-opt"><input type="radio" name="u3" value="B" onchange="checkU(3,'B')"> B &nbsp; Static pressure should continue to decrease because the flow is still moving forward</label>
            <label class="mc-opt"><input type="radio" name="u3" value="C" onchange="checkU(3,'C')"> C &nbsp; Static pressure should remain constant because the geometry changes slowly</label>
            <label class="mc-opt"><input type="radio" name="u3" value="D" onchange="checkU(3,'D')"> D &nbsp; Static pressure should fluctuate randomly as turbulence develops</label>
            <div id="uFb3" class="q-feedback"></div>
          </div>
        </div>

        <!-- U4 ‚Äî correct: D -->
        <div class="u-unit">
          <div class="u-unit-body">
            <span class="q-badge q-obs">Observe</span>
            <div class="u-stem">Q4 ‚Äî Pitot Tube Working Principle</div>
            <div class="u-desc">The pitot tube gives you a total pressure P‚ÇÄ and a static pressure P‚Çõ at the same point. How does this give you velocity?</div>
            <label class="mc-opt"><input type="radio" name="u4" value="A" onchange="checkU(4,'A')"> A &nbsp; Velocity is the ratio P‚ÇÄ / P‚Çõ</label>
            <label class="mc-opt"><input type="radio" name="u4" value="B" onchange="checkU(4,'B')"> B &nbsp; Velocity is proportional to the sum P‚ÇÄ + P‚Çõ</label>
            <label class="mc-opt"><input type="radio" name="u4" value="C" onchange="checkU(4,'C')"> C &nbsp; Velocity is read directly from a calibration chart without any pressure difference</label>
            <label class="mc-opt"><input type="radio" name="u4" value="D" onchange="checkU(4,'D')"> D &nbsp; The dynamic pressure ŒîP = P‚ÇÄ ‚àí P‚Çõ = ¬ΩœÅV¬≤, so V = ‚àö(2ŒîP/œÅ)</label>
            <div id="uFb4" class="q-feedback"></div>
          </div>
        </div>

        <!-- U5 ‚Äî correct: C -->
        <div class="u-unit">
          <div class="u-unit-body">
            <span class="q-badge q-prd">Observe &amp; Predict</span>
            <div class="u-stem">Q5 ‚Äî Pressure Recovery</div>
            <div class="u-desc">Observe the static pressure readings plotted below. Compare P1 (inlet) and P11 (diffuser exit) ‚Äî they have roughly the same cross-sectional area, so in an ideal frictionless flow they would have the same static pressure. What does your data show, and why?</div>
            <div class="q-chart-card">
              <div class="q-chart-title">Static pressure ‚Äî P1 to P11 (your data)</div>
              <canvas id="q5-staticChart" height="160"></canvas>
            </div>
            <label class="mc-opt"><input type="radio" name="u5" value="A" onchange="checkU(5,'A')"> A &nbsp; P1 and P11 are equal ‚Äî Bernoulli guarantees full pressure recovery when the geometry returns to the same area</label>
            <label class="mc-opt"><input type="radio" name="u5" value="B" onchange="checkU(5,'B')"> B &nbsp; P11 is higher than P1 because the flow has slowed down in the diffuser</label>
            <label class="mc-opt"><input type="radio" name="u5" value="C" onchange="checkU(5,'C')"> C &nbsp; P11 is slightly lower than P1 ‚Äî viscous friction along the duct walls dissipates energy as heat, so full static pressure recovery is never achieved</label>
            <label class="mc-opt"><input type="radio" name="u5" value="D" onchange="checkU(5,'D')"> D &nbsp; P11 is much lower than P1 because all the energy has been converted to kinetic energy</label>
            <div id="uFb5" class="q-feedback"></div>
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:20px;">
          <button class="btn-back" onclick="goTo(2)"><span class="arr">‚Üê</span> Back</button>
          <button class="btn-proceed" style="margin-top:0;" onclick="goTo(4)">Move to deep understanding <span class="arr">‚Üí</span></button>
        </div>
      </div>
    </div><!-- /s3 -->

    <!-- ‚ïê‚ïê SLIDE 4 ‚Äî DEEP UNDERSTANDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="slide" id="s4">
      <div class="slide-body">
        <div class="slide-h">Deep Understanding</div>
        <div class="slide-lead">Use your data and the plots below to guide a discussion with your colleagues.</div>

        <!-- DISCUSSION PROMPT -->
        <div class="u-unit" style="border-left:5px solid var(--accent);">
          <div class="u-unit-body">
            <span class="q-badge q-exp" style="background:#e3f2fd;color:#0d47a1;">Discuss with your colleagues</span>
            <div class="u-stem" style="margin-top:10px;">Comparing predictions with pitot tube readings</div>
            <div class="u-desc" style="margin-bottom:18px;">
              In this experiment the pitot tube was read at two locations: the <strong>throat</strong> and a point in the <strong>diffuser</strong>.
              Both readings give total pressure and velocity directly. The plots below show those two measured values
              alongside the predictions derived from the continuity equation at all 11 tapping points.
              <br><br>
              Examine the charts and discuss with your colleagues:
            </div>

            <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;padding-left:4px;">
              <div style="display:flex;gap:10px;align-items:flex-start;">
                <span style="font-family:var(--ff);font-weight:700;color:var(--accent);font-size:1.1rem;flex-shrink:0;">‚ë†</span>
                <span style="font-family:var(--serif);font-size:0.97rem;line-height:1.65;">Do the pitot tube readings of <strong>total pressure</strong> agree with the predicted values at the throat and diffuser? What do you observe?</span>
              </div>
              <div style="display:flex;gap:10px;align-items:flex-start;">
                <span style="font-family:var(--ff);font-weight:700;color:var(--accent);font-size:1.1rem;flex-shrink:0;">‚ë°</span>
                <span style="font-family:var(--serif);font-size:0.97rem;line-height:1.65;">Do the pitot tube readings of <strong>velocity</strong> agree with the continuity predictions at those positions?</span>
              </div>
              <div style="display:flex;gap:10px;align-items:flex-start;">
                <span style="font-family:var(--ff);font-weight:700;color:var(--accent);font-size:1.1rem;flex-shrink:0;">‚ë¢</span>
                <span style="font-family:var(--serif);font-size:0.97rem;line-height:1.65;">Look at the total pressure curve across P1‚ÄìP11. <strong>Why is the predicted total pressure close to zero</strong> at every tapping point? What does this tell you about how the pressures were recorded?</span>
              </div>
            </div>

            <!-- CHART 1: Total pressure ‚Äî prediction vs pitot -->
            <div class="q-chart-card" style="margin-bottom:18px;">
              <div class="q-chart-title">Total pressure (mmH‚ÇÇO) ‚Äî prediction at P1‚ÄìP11 &amp; pitot readings</div>
              <canvas id="dq-totalPChart" height="200"></canvas>
            </div>

            <!-- CHART 2: Velocity ‚Äî prediction vs pitot -->
            <div class="q-chart-card" style="margin-bottom:20px;">
              <div class="q-chart-title">Velocity (m/s) ‚Äî prediction at P1‚ÄìP11 &amp; pitot readings</div>
              <canvas id="dq-velChart" height="200"></canvas>
            </div>

            <!-- HINT ACCORDION -->
            <div style="margin-bottom:16px;">
              <button onclick="toggleDqHint()" id="btn-dq-hint"
                style="font-family:var(--ff);font-size:0.82rem;font-weight:600;padding:9px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text-md);cursor:pointer;min-height:40px;transition:background 0.15s;">
                üí° Show guidance notes
              </button>
              <div id="dq-hint-panel" style="display:none;margin-top:12px;padding:16px 18px;background:#f0faf5;border-left:5px solid var(--ok);border-radius:0 6px 6px 0;">
                <p style="font-family:var(--ff);font-size:0.85rem;font-weight:700;color:#134e35;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.04em;">Guidance notes</p>
                <p style="font-family:var(--serif);font-size:0.93rem;color:#1b4020;line-height:1.75;margin-bottom:10px;">
                  <strong>On total pressure agreement:</strong> In an ideal (inviscid) flow, total pressure P‚ÇÄ = P<sub>static</sub> + ¬ΩœÅV¬≤ is conserved along a streamline (Bernoulli). A pitot tube measures this directly. If the pitot readings match the predicted total pressure, it confirms the flow behaves close to ideal at those positions. Discrepancies ‚Äî particularly a <em>lower</em> pitot total pressure than predicted ‚Äî indicate viscous losses or flow separation between the tapping and the pitot measurement point.
                </p>
                <p style="font-family:var(--serif);font-size:0.93rem;color:#1b4020;line-height:1.75;margin-bottom:10px;">
                  <strong>On velocity agreement:</strong> The continuity prediction assumes a uniform velocity profile across each cross-section. The pitot tube measures velocity at one point (the centreline). In attached turbulent flow, the centreline velocity is typically 10‚Äì20% higher than the bulk average. A large over-reading would suggest flow separation in the diffuser.
                </p>
                <p style="font-family:var(--serif);font-size:0.93rem;color:#1b4020;line-height:1.75;">
                  <strong>Why is total pressure near zero?</strong> The tapping pressures are recorded as <em>gauge</em> values relative to atmospheric ‚Äî the manometer reads the difference from the lab ambient pressure. Since the duct inlet is open to atmosphere and the flow speed is low, the absolute total pressure throughout the duct is very close to atmospheric. Expressed as gauge (i.e. relative to atmospheric), total pressure ‚âà P<sub>static,gauge</sub> + q ‚âà 0. Any non-zero value you see represents small losses and the slight sub-atmospheric condition created by the fan.
                </p>
              </div>
            </div>

          </div>
        </div>

        <div class="completion-banner show" id="completion-banner">
          <div class="completion-icon">üéâ</div>
          <div class="completion-title">Activity complete!</div>
          <div class="completion-msg">
            Well done ‚Äî you have recorded your measurements, analysed the pressure and velocity distributions, answered the understanding questions, and discussed the comparison between predictions and direct pitot tube readings.
            Use the numbered steps above to revisit any section.
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:20px;">
          <button class="btn-back" onclick="goTo(3)"><span class="arr">‚Üê</span> Back</button>
        </div>
      </div>
    </div><!-- /s4 -->

  </div><!-- /slides-viewport -->
</div><!-- /wizard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
/* ‚îÄ‚îÄ‚îÄ TAPPING DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const TAPS = [
  { id:1,  w:149.0,  A:22350.0,  zone:'c' },
  { id:2,  w:132.4,  A:19860.0,  zone:'c' },
  { id:3,  w:115.8,  A:17370.0,  zone:'c' },
  { id:4,  w:100.0,  A:15000.0,  zone:'t' },
  { id:5,  w:100.0,  A:15000.0,  zone:'t' },
  { id:6,  w:100.0,  A:15000.0,  zone:'t' },
  { id:7,  w:109.3,  A:16395.0,  zone:'d' },
  { id:8,  w:119.35, A:17902.5,  zone:'d' },
  { id:9,  w:129.4,  A:19410.0,  zone:'d' },
  { id:10, w:139.4,  A:20910.0,  zone:'d' },
  { id:11, w:149.4,  A:22410.0,  zone:'d' },
];
const Z_COLOR = { c: '#b45309', t: '#1a7a4a', d: '#1a56a0' };
const Z_LABEL = { c: 'Contraction', t: 'Throat', d: 'Diffuser' };

let charts = {};
let answeredQs = new Set(), answeredUs = new Set();

/* ‚îÄ‚îÄ‚îÄ UNIT CONVERSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toPa(v, unit) {
  if (unit === 'Pa')    return v;
  if (unit === 'mmH2O') return v * 9.80665;
  if (unit === 'mbar')  return v * 100;
  if (unit === 'mmHg')  return v * 133.322;
  return v;
}

/* ‚îÄ‚îÄ‚îÄ DIAGRAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(function buildDiagram() {
  const svg = document.getElementById('diag-svg');
  const W = 820, H = 170, CY = 85;
  const SCALE = 0.4; // mm ‚Üí px for width display
  const xStep = W / (TAPS.length + 1);
  const xPos = TAPS.map((_, i) => xStep + i * xStep);
  
  let topPts = [], botPts = [];
  xPos.forEach((x, i) => {
    const hw = TAPS[i].w * SCALE / 2;
    topPts.push([x, CY - hw]);
    botPts.push([x, CY + hw]);
  });
  // Extend to edges
  const topPath = `M 0,${topPts[0][1]} ` + topPts.map(p=>`L ${p[0]},${p[1]}`).join(' ') + ` L ${W},${topPts[10][1]}`;
  const botPath = `M 0,${botPts[0][1]} ` + botPts.map(p=>`L ${p[0]},${p[1]}`).join(' ') + ` L ${W},${botPts[10][1]}`;

  let html = '';
  html += `<path d="${topPath}" stroke="#1a2e44" stroke-width="2.2" fill="none" stroke-linejoin="round"/>`;
  html += `<path d="${botPath}" stroke="#1a2e44" stroke-width="2.2" fill="none" stroke-linejoin="round"/>`;

  // Zone shading
  const zBounds = [
    { x1: xPos[0]-xStep*0.5, x2: (xPos[2]+xPos[3])/2, color:'rgba(180,83,9,0.06)' },
    { x1: (xPos[2]+xPos[3])/2, x2: (xPos[5]+xPos[6])/2, color:'rgba(26,122,74,0.07)' },
    { x1: (xPos[5]+xPos[6])/2, x2: xPos[10]+xStep*0.5, color:'rgba(26,86,160,0.06)' },
  ];
  // (simple rects for zone shading ‚Äî approximate)
  ['Contraction','Throat','Diffuser'].forEach((label, zi) => {
    const x1 = zBounds[zi].x1, x2 = zBounds[zi].x2;
    html += `<rect x="${x1}" y="${CY-50}" width="${x2-x1}" height="100" fill="${zBounds[zi].color}" rx="0"/>`;
  });

  // Tap markers
  xPos.forEach((x, i) => {
    const col = Z_COLOR[TAPS[i].zone];
    const [ty, by] = [topPts[i][1], botPts[i][1]];
    html += `<line x1="${x}" y1="${ty}" x2="${x}" y2="${ty-14}" stroke="${col}" stroke-width="1.4" stroke-dasharray="3,2"/>`;
    html += `<circle cx="${x}" cy="${ty}" r="3.5" fill="${col}"/>`;
    html += `<text x="${x}" y="${ty-18}" text-anchor="middle" fill="${col}" font-size="10" font-weight="700" font-family="monospace">P${TAPS[i].id}</text>`;
    // bottom dimension
    html += `<line x1="${x}" y1="${by}" x2="${x}" y2="${by+10}" stroke="${col}" stroke-width="1" stroke-dasharray="2,2"/>`;
  });

  // Flow arrow
  html += `<defs><marker id="arr" markerWidth="7" markerHeight="7" refX="5" refY="3.5" orient="auto"><polygon points="0,0 7,3.5 0,7" fill="#1a56a0"/></marker></defs>`;
  html += `<line x1="16" y1="${CY}" x2="50" y2="${CY}" stroke="#1a56a0" stroke-width="1.8" marker-end="url(#arr)"/>`;
  html += `<text x="14" y="${CY-6}" fill="#718096" font-size="9" font-family="monospace">Q</text>`;

  // Zone labels at bottom
  html += `<text x="${(xPos[0]+xPos[2])/2}" y="163" text-anchor="middle" fill="#92400e" font-size="9" font-family="monospace">CONTRACTION</text>`;
  html += `<text x="${(xPos[3]+xPos[5])/2}" y="163" text-anchor="middle" fill="#134e35" font-size="9" font-family="monospace">THROAT</text>`;
  html += `<text x="${(xPos[6]+xPos[10])/2}" y="163" text-anchor="middle" fill="#0f3675" font-size="9" font-family="monospace">DIFFUSER</text>`;

  svg.innerHTML = html;
})();

/* ‚îÄ‚îÄ‚îÄ TRAVERSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function addTraverse() {
  traverseCount++;
  const id = traverseCount;
  const card = document.createElement('div');
  card.className = 'pitot-card';
  card.id = 'trav-' + id;
  card.innerHTML = `
    <div class="pitot-card-head">
      <span class="pitot-label" id="trav-lbl-${id}">Traverse ${id}</span>
      ${id > 1 ? `<button class="btn-rm" onclick="removeTraverse(${id})">Remove</button>` : ''}
    </div>
    <div class="pitot-fields">
      <div class="tap-fld f-diff">
        <label>Position from P7 (mm)</label>
        <input type="number" id="trav-pos-${id}" step="1" placeholder="e.g. 50" inputmode="decimal" oninput="watchTraverse(${id})">
      </div>
      <div class="tap-fld f-diff">
        <label>Total pressure P‚ÇÄ</label>
        <input type="number" id="trav-p0-${id}" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="watchTraverse(${id})">
      </div>
      <div class="tap-fld f-diff">
        <label>Static pressure P‚Çõ</label>
        <input type="number" id="trav-ps-${id}" step="0.1" placeholder="‚Äî" inputmode="decimal" oninput="watchTraverse(${id})">
      </div>
    </div>`;
  document.getElementById('traverse-wrap').appendChild(card);
}
function removeTraverse(id) { document.getElementById('trav-' + id)?.remove(); }
function watchTraverse(id) {
  const p0 = parseFloat(document.getElementById('trav-p0-' + id)?.value);
  const ps = parseFloat(document.getElementById('trav-ps-' + id)?.value);
  const pos = parseFloat(document.getElementById('trav-pos-' + id)?.value);
  const ok = !isNaN(p0) && !isNaN(ps) && !isNaN(pos);
  const card = document.getElementById('trav-' + id);
  const lbl  = document.getElementById('trav-lbl-' + id);
  if (card) card.classList.toggle('complete', ok);
  if (lbl)  lbl.classList.toggle('complete', ok);
}

/* ‚îÄ‚îÄ‚îÄ READY CHECK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function checkReady() {
  // Need at least one tapping + pitot data to proceed
  const anyTap = TAPS.some(t => {
    const v = parseFloat(document.getElementById('p' + t.id)?.value);
    return !isNaN(v);
  });
  const hasPitot = (
    (!isNaN(parseFloat(document.getElementById('pitot-v')?.value))) ||
    (!isNaN(parseFloat(document.getElementById('pitot-p0')?.value)) &&
     !isNaN(parseFloat(document.getElementById('pitot-ps')?.value)))
  );
  document.getElementById('btn-analyse').disabled = !(anyTap && hasPitot);
}

/* ‚îÄ‚îÄ‚îÄ ANALYSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function runAnalysis() {
  const rho  = parseFloat(document.getElementById('inp-rho').value) || 1.225;
  const unit = document.getElementById('inp-punit').value;
  const ptype = document.getElementById('inp-ptype').value;

  function getPa(rawId) {
    const el = document.getElementById(rawId);
    if (!el || el.value === '') return null;
    return toPa(parseFloat(el.value), unit);
  }

  // Throat velocity
  let Vt = null;
  const directV = parseFloat(document.getElementById('pitot-v')?.value);
  if (!isNaN(directV) && directV > 0) {
    Vt = directV;
  } else {
    const p0 = getPa('pitot-p0'), ps = getPa('pitot-ps');
    if (p0 !== null && ps !== null && p0 > ps) {
      Vt = Math.sqrt(2 * (p0 - ps) / rho);
    }
  }
  if (!Vt) { alert('Please enter valid pitot tube readings.'); return; }

  const A_throat = 15000; // mm¬≤ (average P4‚ÄìP6)
  const q_throat = 0.5 * rho * Vt * Vt;

  // Static pressures (keep in Pa)
  const Pstatic = TAPS.map(t => getPa('p' + t.id));

  // Reference static: use P4 (first throat)
  const Pref = Pstatic[3]; // index 3 = P4

  // Build results
  const results = TAPS.map((t, i) => {
    const P = Pstatic[i];
    const V = Vt * (A_throat / t.A);
    const q = 0.5 * rho * V * V;
    // Total pressure: static (negated, i.e. gauge sign) + dynamic
    const Ptotal = (P !== null) ? (-P + q) : null;
    const Cp = (P !== null && Pref !== null) ? (P - Pref) / q_throat : null;
    return { tap: t, P, V, q, Ptotal, Cp };
  });

  // Store globally so slide-3 mini-charts can access results after navigation
  window._lastResults = results;

  // Render main chart
  buildPressureChart(results);

  goTo(2);
}

function makeLineDataset(label, data, color, dash) {
  return {
    label, data,
    borderColor: color,
    backgroundColor: color,
    borderWidth: 2.5,
    borderDash: dash || [],
    pointRadius: 6,
    pointHoverRadius: 8,
    pointBackgroundColor: '#fff',
    pointBorderColor: color,
    pointBorderWidth: 2.5,
    tension: 0.35,
    fill: false,
  };
}

function buildPressureChart(results) {
  if (charts.main) { try { charts.main.destroy(); } catch(e){} }
  const labels  = results.map(r => 'P' + r.tap.id);
  const pStatic = results.map(r => r.P !== null ? parseFloat((-r.P).toFixed(2)) : null);
  const pDyn    = results.map(r => parseFloat(r.q.toFixed(2)));
  const pTotal  = results.map(r => r.Ptotal !== null ? parseFloat(r.Ptotal.toFixed(2)) : null);
  charts.main = new Chart(document.getElementById('pressureChart').getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        makeLineDataset('Static pressure (Pa)',  pStatic, '#1a56a0'),
        makeLineDataset('Dynamic pressure (Pa)', pDyn,    '#bf360c'),
        makeLineDataset('Total pressure (Pa)',   pTotal,  '#263238', [6,3]),
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 14, font: { size: 13, family: 'Inter' }, padding: 20 } },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          title: { display: true, text: 'Pressure (Pa)', font: { size: 13, family: 'Inter' } },
          grid: { color: '#e2e8f0' }
        },
        x: {
          title: { display: true, text: 'Tapping point', font: { size: 13, family: 'Inter' } },
          grid: { color: '#e2e8f0' }
        }
      }
    }
  });
}

/* mini charts for slide-3 questions ‚Äî called when slide 3 becomes visible */
function buildMiniCharts() {
  const results = window._lastResults;
  if (!results) return;
  const labels = results.map(r => 'P' + r.tap.id);

  // Q1: velocity chart
  if (charts.q1vel) { try { charts.q1vel.destroy(); } catch(e){} }
  const canvas1 = document.getElementById('q1-velChart');
  if (canvas1) {
    charts.q1vel = new Chart(canvas1.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [makeLineDataset('Velocity (m/s)', results.map(r => parseFloat(r.V.toFixed(3))), '#1a7a4a')]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { title: { display: true, text: 'V (m/s)', font: { size: 11, family: 'Inter' } }, grid: { color: '#e2e8f0' } },
          x: { title: { display: true, text: 'Tapping point', font: { size: 11, family: 'Inter' } }, grid: { color: '#e2e8f0' } }
        }
      }
    });
  }

  // Q5: static pressure only
  if (charts.q5stat) { try { charts.q5stat.destroy(); } catch(e){} }
  const canvas5 = document.getElementById('q5-staticChart');
  if (canvas5) {
    const pStatic = results.map(r => r.P !== null ? parseFloat((-r.P).toFixed(2)) : null);
    charts.q5stat = new Chart(canvas5.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [makeLineDataset('Static pressure (Pa)', pStatic, '#1a56a0')]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { title: { display: true, text: 'Static P (Pa)', font: { size: 11, family: 'Inter' } }, grid: { color: '#e2e8f0' } },
          x: { title: { display: true, text: 'Tapping point', font: { size: 11, family: 'Inter' } }, grid: { color: '#e2e8f0' } }
        }
      }
    });
  }
}

function tryNextImgSrc(img) {
  // Try alternative raw URL formats if the first fails
  const srcs = [
    'https://raw.githubusercontent.com/Nidiana/LabsDiscussion/main/FlowEnergyConversion/tappings.PNG',
    'https://cdn.jsdelivr.net/gh/Nidiana/LabsDiscussion@main/FlowEnergyConversion/tappings.PNG',
    'https://raw.githubusercontent.com/Nidiana/LabsDiscussion/HEAD/FlowEnergyConversion/tappings.PNG',
  ];
  const tried = img.dataset.tried ? parseInt(img.dataset.tried) : 0;
  if (tried < srcs.length) {
    img.dataset.tried = tried + 1;
    img.src = srcs[tried];
  } else {
    img.style.display = 'none';
    document.getElementById('tappings-fallback').style.display = 'block';
  }
}

function toggleDynInfo() {
  const panel = document.getElementById('dyn-info-panel');
  const btn   = document.getElementById('btn-dyn-info');
  const open  = panel.style.display === 'none';
  panel.style.display = open ? 'block' : 'none';
  btn.classList.toggle('open', open);
  btn.textContent = open ? 'Hide explanation ‚ñ≤' : 'How is dynamic pressure calculated?';
}

/* ‚îÄ‚îÄ‚îÄ QUIZ ‚Äî UNDERSTANDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const U_CORRECT = { 1:'B', 2:'C', 3:'A', 4:'D', 5:'C' };
const U_FB = {
  1: {
    B: `<strong>‚úì Correct.</strong> By the continuity equation Q = A¬∑V = constant, a smaller cross-sectional area must be accompanied by a higher velocity. The throat is the narrowest section, so it has the highest air speed. Your pitot reading at the throat is therefore the maximum velocity in the duct.`,
    def: `<strong>‚úó Incorrect ‚Äî correct answer: B.</strong> The continuity equation Q = A¬∑V = constant means velocity and area are inversely related. The throat has the smallest area, so air must move fastest there.`
  },
  2: {
    C: `<strong>‚úì Correct.</strong> Conservation of mass for steady, incompressible flow gives Q = A‚ÇÅV‚ÇÅ = A‚ÇÇV‚ÇÇ = ‚Ä¶ = constant. Knowing Q at the throat (from the pitot) and the known areas at every other position allows us to calculate V at each point without any additional measurement. This is the continuity equation in action.`,
    def: `<strong>‚úó Incorrect ‚Äî correct answer: C.</strong> Conservation of mass (continuity) is the principle: Q = A¬∑V = constant for incompressible steady flow. This lets you propagate a single velocity measurement to all other cross-sections using their known areas.`
  },
  3: {
    A: `<strong>‚úì Correct.</strong> In the diffuser, area increases so continuity demands velocity decreases. By Bernoulli's principle (P + ¬ΩœÅV¬≤ ‚âà const), falling velocity means rising static pressure. This is "pressure recovery" ‚Äî kinetic energy is being converted back to pressure. In a real duct this recovery is incomplete due to viscous losses.`,
    def: `<strong>‚úó Incorrect ‚Äî correct answer: A.</strong> Continuity: larger area ‚Üí lower velocity. Bernoulli: lower velocity ‚Üí higher static pressure. The diffuser recovers some of the pressure that was "traded" for kinetic energy in the contraction.`
  },
  4: {
    D: `<strong>‚úì Correct.</strong> Bernoulli along the stagnation streamline gives P‚ÇÄ = P‚Çõ + ¬ΩœÅV¬≤. The total pressure (stagnation) P‚ÇÄ is measured by the forward-facing hole and the static pressure P‚Çõ by the side hole. Their difference is the dynamic pressure, giving V = ‚àö(2(P‚ÇÄ ‚àí P‚Çõ)/œÅ).`,
    def: `<strong>‚úó Incorrect ‚Äî correct answer: D.</strong> The pitot exploits Bernoulli along the stagnation streamline: P‚ÇÄ ‚àí P‚Çõ = ¬ΩœÅV¬≤. Measuring both pressures and dividing by ¬ΩœÅ then taking the square root gives velocity.`
  },
  5: {
    C: `<strong>‚úì Correct.</strong> In a real duct, viscous friction continuously dissipates mechanical energy along the flow path, converting it to heat. Even though the geometry at P11 is similar to P1, total and static pressure will be slightly lower at the exit. The longer the duct and the higher the velocity, the larger this loss. It is why wind tunnels require a powered fan to maintain flow.`,
    def: `<strong>‚úó Incorrect ‚Äî correct answer: C.</strong> Viscous friction dissipates energy along the flow. The static pressure at P11 will be slightly lower than at P1 because some mechanical energy has been converted to heat ‚Äî regardless of the geometry returning to the same cross-sectional area.`
  }
};

function checkU(qNum, answer) {
  if (answeredUs.has(qNum)) return;
  answeredUs.add(qNum);
  document.querySelectorAll(`input[name="u${qNum}"]`).forEach(r => { r.disabled = true; r.closest('.mc-opt').classList.add('locked'); });
  const fb = document.getElementById('uFb' + qNum);
  const ok = answer === U_CORRECT[qNum];
  fb.innerHTML = ok ? (U_FB[qNum][answer] || U_FB[qNum].def) : (U_FB[qNum][answer] || U_FB[qNum].def);
  fb.className = 'q-feedback ' + (ok ? 'fb-ok' : 'fb-err') + ' show';
  const n = answeredUs.size;
  document.getElementById('uprog-lbl').textContent = `${n} of 5 answered`;
  document.getElementById('uprog-fill').style.width = `${n/5*100}%`;
  fb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

/* ‚îÄ‚îÄ‚îÄ DEEP UNDERSTANDING ‚Äî hint toggle + charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleDqHint() {
  const panel = document.getElementById('dq-hint-panel');
  const btn   = document.getElementById('btn-dq-hint');
  const open  = panel.style.display === 'none';
  panel.style.display = open ? 'block' : 'none';
  btn.textContent = open ? 'üí° Hide guidance notes' : 'üí° Show guidance notes';
}

function buildDqCharts() {
  const results = window._lastResults;
  if (!results) return;
  const rho  = parseFloat(document.getElementById('inp-rho').value) || 1.225;
  const unit = document.getElementById('inp-punit').value;  // mmH2O

  function getPa(id) {
    const el = document.getElementById(id);
    if (!el || el.value === '') return null;
    return toPa(parseFloat(el.value), unit);
  }
  function toMmH2O(pa) { return pa / 9.80665; }

  const labels = results.map(r => 'P' + r.tap.id);

  // Predicted total pressure in mmH2O (= -static_gauge + dynamic; static already negated in Ptotal)
  const predTotalMmH2O = results.map(r =>
    r.Ptotal !== null ? parseFloat(toMmH2O(r.Ptotal).toFixed(2)) : null
  );

  // Pitot throat: total pressure reading (P0) in mmH2O ‚Äî user entered positive gauge
  const throatP0_raw = parseFloat(document.getElementById('pitot-p0')?.value);
  const diffP0_raw   = parseFloat(document.getElementById('diff-p0')?.value);

  // Throat pitot is at ~P4-P6 region, place at index 4 (P5 = centre throat)
  // Diffuser pitot is between P7-P8, place at index 6 (P7)
  const pitotTotalMmH2O = results.map((r, i) => null); // sparse
  if (!isNaN(throatP0_raw)) pitotTotalMmH2O[4] = parseFloat(throatP0_raw.toFixed(2));  // P5
  if (!isNaN(diffP0_raw))   pitotTotalMmH2O[6] = parseFloat(diffP0_raw.toFixed(2));    // P7

  // Predicted velocity m/s
  const predVel = results.map(r => parseFloat(r.V.toFixed(3)));

  // Pitot velocities (sparse)
  const pitotVel = results.map(() => null);
  // Throat velocity
  let Vt = null;
  const directV = parseFloat(document.getElementById('pitot-v')?.value);
  if (!isNaN(directV) && directV > 0) {
    Vt = directV;
  } else {
    const p0 = getPa('pitot-p0'), ps = getPa('pitot-ps');
    if (p0 !== null && ps !== null && p0 > ps) Vt = Math.sqrt(2*(p0-ps)/rho);
  }
  if (Vt) pitotVel[4] = parseFloat(Vt.toFixed(3));  // P5

  // Diffuser velocity
  let Vd = null;
  const directVd = parseFloat(document.getElementById('diff-v')?.value);
  if (!isNaN(directVd) && directVd > 0) {
    Vd = directVd;
  } else {
    const p0d = getPa('diff-p0'), psd = getPa('diff-ps');
    if (p0d !== null && psd !== null && p0d > psd) Vd = Math.sqrt(2*(p0d-psd)/rho);
  }
  if (Vd) pitotVel[6] = parseFloat(Vd.toFixed(3));  // P7

  // ‚îÄ‚îÄ CHART 1: Total pressure ‚îÄ‚îÄ
  if (charts.dqTot) { try { charts.dqTot.destroy(); } catch(e){} }
  charts.dqTot = new Chart(document.getElementById('dq-totalPChart').getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Predicted total pressure (mmH‚ÇÇO)',
          data: predTotalMmH2O,
          borderColor: '#263238',
          backgroundColor: '#263238',
          borderWidth: 2.5,
          borderDash: [6, 3],
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#fff',
          pointBorderColor: '#263238',
          pointBorderWidth: 2.5,
          tension: 0.35,
          fill: false,
        },
        {
          label: 'Pitot total pressure (mmH‚ÇÇO)',
          data: pitotTotalMmH2O,
          borderColor: '#e65100',
          backgroundColor: '#e65100',
          borderWidth: 0,
          pointRadius: results.map((r,i) => pitotTotalMmH2O[i] !== null ? 10 : 0),
          pointHoverRadius: 12,
          pointStyle: 'rectRot',
          pointBackgroundColor: '#e65100',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          tension: 0,
          fill: false,
          spanGaps: false,
          showLine: false,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 14, font: { size: 12, family: 'Inter' }, padding: 18 } },
        tooltip: { mode: 'index', intersect: false,
          callbacks: { label: ctx => ctx.raw !== null ? `${ctx.dataset.label}: ${ctx.raw}` : null }
        }
      },
      scales: {
        y: { title: { display: true, text: 'Total pressure (mmH‚ÇÇO)', font: { size: 12, family: 'Inter' } }, grid: { color: '#e2e8f0' } },
        x: { title: { display: true, text: 'Tapping point', font: { size: 12, family: 'Inter' } }, grid: { color: '#e2e8f0' } }
      }
    }
  });

  // ‚îÄ‚îÄ CHART 2: Velocity ‚îÄ‚îÄ
  if (charts.dqVel) { try { charts.dqVel.destroy(); } catch(e){} }
  charts.dqVel = new Chart(document.getElementById('dq-velChart').getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Predicted velocity ‚Äî continuity (m/s)',
          data: predVel,
          borderColor: '#1a7a4a',
          backgroundColor: '#1a7a4a',
          borderWidth: 2.5,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#fff',
          pointBorderColor: '#1a7a4a',
          pointBorderWidth: 2.5,
          tension: 0.35,
          fill: false,
        },
        {
          label: 'Pitot velocity (m/s)',
          data: pitotVel,
          borderColor: '#e65100',
          backgroundColor: '#e65100',
          borderWidth: 0,
          pointRadius: results.map((r,i) => pitotVel[i] !== null ? 10 : 0),
          pointHoverRadius: 12,
          pointStyle: 'rectRot',
          pointBackgroundColor: '#e65100',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          tension: 0,
          fill: false,
          spanGaps: false,
          showLine: false,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 14, font: { size: 12, family: 'Inter' }, padding: 18 } },
        tooltip: { mode: 'index', intersect: false,
          callbacks: { label: ctx => ctx.raw !== null ? `${ctx.dataset.label}: ${ctx.raw}` : null }
        }
      },
      scales: {
        y: { title: { display: true, text: 'Velocity (m/s)', font: { size: 12, family: 'Inter' } }, grid: { color: '#e2e8f0' } },
        x: { title: { display: true, text: 'Tapping point', font: { size: 12, family: 'Inter' } }, grid: { color: '#e2e8f0' } }
      }
    }
  });
}

/* ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function goTo(n) {
  document.querySelectorAll('.slide').forEach(s => {
    if (s.classList.contains('active')) {
      s.classList.remove('active');
      s.classList.add('exit');
      setTimeout(() => s.classList.remove('exit'), 340);
    }
  });
  document.getElementById('s' + n).classList.add('active');
  document.getElementById('s' + n).scrollTop = 0;
  for (let i = 1; i <= 4; i++) {
    const p = document.getElementById('sp' + i);
    p.classList.remove('active', 'done');
    if (i < n)      p.classList.add('done');
    else if (i === n) p.classList.add('active');
  }
  // Build mini-charts when landing on slide 3 or 4
  if (n === 3) { setTimeout(buildMiniCharts, 50); }
  if (n === 4) { setTimeout(buildDqCharts, 50); }
}

</script>

    <div class="copyright">
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />
            &copy; 2025 Nidiana Rosado Hau, University of Sheffield
      </div>
</body>
</html>
